# =============================================================================
# Unit Test Agent 4j - Configuration File
# =============================================================================

# LLM Settings
llm:
  protocol: "openai"                      # openai | openai-zhipu | anthropic | gemini
  api-key: "${env:UT_AGENT_API_KEY}"       # API Key (supports env var)
  base-url: "${env:UT_AGENT_BASE_URL}"     # Base URL (auto handles /v1 suffix)
  model-name: "${env:UT_AGENT_MODEL_NAME}" # Model name
  temperature: 0.0                        # 0.0 (precise) ~ 1.0 (creative)
  timeout: 120                            # Request timeout in seconds
  custom-headers: {}                       # Custom HTTP headers (optional)
    # X-Custom-Header: "value"

# Workflow Settings
workflow:
  max-retries: 5                           # Max retry attempts on failure
  coverage-threshold: 80                   # Coverage threshold (%)
  interactive: false                      # Interactive confirmation mode
  use-lsp: false                          # Use LSP for syntax check (auto-downloads JDT LS)
  iterative-mode: false                   # Enable iterative method testing mode
  method-coverage-threshold: 80           # Per-method coverage threshold (%)
  skip-low-priority: false                # Skip low-priority methods (P2) in iterative mode
  max-stale-iterations: 3                 # Stop after N iterations without progress
  min-coverage-gain: 1                    # Minimum coverage gain (%) per iteration to continue
  enable-phase-switching: false           # Enable dynamic phase switching (default: false for backward compatibility)

# Batch Mode Settings (for --project)
batch:
  exclude-patterns: ""                     # Glob patterns to exclude (comma-separated)
    # Example: "**/dto/**,**/vo/**,**/domain/**"
  dry-run: false                           # Analyze only, no generation

# Incremental Mode Settings (for --incremental)
incremental:
  mode: "uncommitted"                     # uncommitted | staged | compare
  # base-ref: "main"                       # Base ref for compare mode (required for compare)
  target-ref: "HEAD"                       # Target ref for compare mode
  # exclude-patterns: ".*Test\\.java"      # Regex patterns to exclude files

# Recommended Dependencies & Minimum Versions (for env check)
dependencies:
  junit-jupiter: "5.10.1"
  mockito-core: "5.8.0"
  mockito-junit-jupiter: "5.8.0"
  mockito-inline: "5.8.0"
  byte-buddy: "1.14.10"
  objenesis: "3.3"
  jacoco-maven-plugin: "0.8.11"

# Prompts Configuration
prompts:
  system: "prompts/system-prompt.st"      # System prompt template path

# MCP Configuration (Model Context Protocol)
mcp:
  servers: []                             # MCP server configurations
    # - name: "server-name"
    #   url: "http://localhost:8080"

# Skills Configuration - 工作流阶段文档参考
# 以下配置描述了完整单测生成流程中各阶段使用的工具
# 实际运行时始终加载所有工具，LLM 根据当前任务自主选择
# 完整流程: 分析(analysis) → 生成(generation) → 验证(verification) → 修复(repair)
# Note: LspSyntaxCheckerTool 仅在 use-lsp=true 时加载
skills:
  # Analysis phase - read and understand source code
  - name: "analysis"
    description: "Code analysis phase - read and understand source code"
    tools:
      - CodeAnalyzerTool
      - FileSystemTool
      - DirectoryTool           # 环境准备需要
      - BoundaryAnalyzerTool
      - StyleAnalyzerTool
      - ProjectScannerTool
      - TestDiscoveryTool

  # Generation phase - generate and write test code
  - name: "generation"
    description: "Test generation phase - generate and write test files"
    tools:
      - FileSystemTool
      - DirectoryTool
      - KnowledgeBaseTool
      - SyntaxCheckerTool       # CompileGuard 强制要求
      - LspSyntaxCheckerTool    # LSP 模式语义检查
      - CodeAnalyzerTool

  # Verification phase - run tests and check coverage
  - name: "verification"
    description: "Test verification phase - execute tests and check coverage"
    tools:
      - MavenExecutorTool
      - SyntaxCheckerTool       # CompileGuard 强制要求
      - LspSyntaxCheckerTool    # LSP 模式语义检查
      - TestReportTool
      - CoverageTool
      - FileSystemTool
      - MutationTestTool

  # Repair phase - fix failing tests
  - name: "repair"
    description: "Repair phase - fix test failures based on error reports"
    tools:
      - FileSystemTool
      - TestReportTool
      - CodeAnalyzerTool
      - SyntaxCheckerTool       # CompileGuard 强制要求
      - LspSyntaxCheckerTool    # LSP 模式语义检查
      - MavenExecutorTool
      - CoverageTool            # 修复后验证覆盖率

  # Iterative mode - per-method test generation (complete workflow)
  - name: "iterative"
    description: "Iterative mode - generate tests method by method with priority"
    tools:
      - CodeAnalyzerTool
      - CoverageTool
      - MethodIteratorTool
      - FileSystemTool
      - DirectoryTool
      - SyntaxCheckerTool       # CompileGuard 强制要求
      - LspSyntaxCheckerTool    # LSP 模式语义检查
      - MavenExecutorTool
      - TestReportTool
      - KnowledgeBaseTool
      - BoundaryAnalyzerTool    # 边界测试建议

  # Incremental mode - Git-based change detection
  - name: "incremental"
    description: "Incremental mode - only test changed files from Git"
    tools:
      - GitDiffTool             # Git 差异分析
      - CodeAnalyzerTool
      - FileSystemTool
      - DirectoryTool
      - SyntaxCheckerTool
      - LspSyntaxCheckerTool
      - MavenExecutorTool
      - CoverageTool
      - TestReportTool
      - KnowledgeBaseTool

  # Full toolset (default) - use all available tools
  - name: "full"
    description: "Full toolset - use all available tools"
    tools: []  # Empty means use all tools
