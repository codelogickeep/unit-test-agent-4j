# Unit Test Agent 4j - 开发路线图

**版本**: 0.2.0  
**更新日期**: 2026-01-12  
**系统定位**: 纯 CLI 工具

---

## 开发阶段总览

| 阶段 | 名称 | 状态 | 优先级 |
|------|------|------|--------|
| Phase 1 | 技术债务清理 | 🔄 进行中 | 最高 |
| Phase 2 | 测试模板与项目规范学习 | ✅ 已完成 | 高 |
| Phase 3 | 测试执行结果分析与自动修复增强 | ✅ 已完成 | 高 |
| Phase 4 | Git 增量检测 | ✅ 已完成 | 中 |
| Phase 5 | 测试质量评估与反馈循环 | ⏳ 待开始 | 中 |

---

## Phase 1: 技术债务清理 (Technical Debt Cleanup)

**目标**: 提升系统鲁棒性，为后续复杂功能打好基础。

### 1.1 为核心 Tools 编写单元测试

| 任务 | 状态 | 说明 |
|------|------|------|
| FileSystemTool 单元测试 | ✅ | 测试路径安全、读写操作、交互模式 |
| DirectoryTool 单元测试 | ✅ | 测试目录操作 |
| CodeAnalyzerTool 单元测试 | ✅ | 测试 AST 解析 |
| CoverageTool 单元测试 | ✅ | 测试 JaCoCo XML 解析 |
| MavenExecutorTool 单元测试 | ⏳ | 测试命令构建（Mock 进程执行） |
| ProjectScannerTool 单元测试 | ⏳ | 测试排除规则 |
| TestDiscoveryTool 单元测试 | ⏳ | 测试测试类发现 |
| KnowledgeBaseTool 单元测试 | ⏳ | 测试 RAG 检索 |

### 1.2 统一异常处理与错误报告

| 任务 | 状态 | 说明 |
|------|------|------|
| 定义统一异常类 `AgentToolException` | ✅ | 包含 ErrorCode + Context |
| 规范所有工具类异常抛出 | ⏳ | 替换原有的 IOException/RuntimeException |
| 增强错误信息可读性 | ⏳ | 提供修复建议 |

### 1.3 配置验证与默认值增强

| 任务 | 状态 | 说明 |
|------|------|------|
| AppConfig 必填字段校验 | ✅ | llm.apiKey, llm.modelName 必填 |
| 智能默认值 | ✅ | temperature=0.0, timeout=120s |
| 配置加载错误友好提示 | ⏳ | 指明具体缺失字段 |

### 1.4 日志分级精细化

| 任务 | 状态 | 说明 |
|------|------|------|
| 区分 INFO/DEBUG 级别 | ⏳ | INFO: 用户进度；DEBUG: 技术细节 |
| 添加 --verbose 参数 | ⏳ | 控制详细日志输出 |
| 工具输入输出日志统一格式 | ✅ | 已完成 |

### 1.5 项目结构解耦

| 任务 | 状态 | 说明 |
|------|------|------|
| 检查循环依赖 | ⏳ | 使用 jdeps 分析 |
| 优化 AgentOrchestrator | ⏳ | 提取通用逻辑 |

---

## Phase 2: 测试模板与项目规范学习 (Template & Spec Learning)

**目标**: 生成的测试代码"完美融入项目"，而非"通用样板"。

### 2.1 代码风格自动提取

| 任务 | 状态 | 说明 |
|------|------|------|
| 分析现有测试代码风格 | ✅ | Mock 偏好、断言风格、命名惯例 |
| 新增 `StyleAnalyzerTool` | ✅ | 提取项目测试规范 |

### 2.2 RAG 知识库增强

| 任务 | 状态 | 说明 |
|------|------|------|
| 支持检索 Markdown 文档 | ✅ | CONTRIBUTING.md, TestingGuide.md |
| 知识库索引持久化 | ⏳ | 避免每次重建 |

### 2.3 动态 Prompt 组装

| 任务 | 状态 | 说明 |
|------|------|------|
| 根据项目规范调整 System Prompt | ✅ | 动态注入断言风格、命名规范 |

---

## Phase 3: 测试执行结果分析与自动修复增强 (Enhanced Self-Healing)

**目标**: 从"重试"进化为"有目的的修复"。

### 3.1 Surefire 报告解析器

| 任务 | 状态 | 说明 |
|------|------|------|
| 新增 `TestReportTool` | ✅ | 解析 surefire-reports/*.xml |
| 区分错误类型 | ✅ | 编译失败/断言失败/超时/依赖缺失 |

### 3.2 错误分类修复策略

| 任务 | 状态 | 说明 |
|------|------|------|
| 编译错修复策略 | ✅ | 检查导包、泛型、Mock 类型 |
| 断言失败修复策略 | ✅ | 分析预期值与实际值差异 |
| 环境/依赖错修复策略 | ✅ | 建议或修改 pom.xml |

### 3.3 修复轨迹记录

| 任务 | 状态 | 说明 |
|------|------|------|
| 记录修复过程 | ✅ | 避免死循环 |
| 修复历史上下文传递 | ✅ | 让 Agent 知道之前尝试过什么 |

---

## Phase 4: Git 增量检测 (Git Incremental Detection)

**目标**: "只为变更买单"，提升大规模工程运行效率。

### 4.1 JGit 集成

| 任务 | 状态 | 说明 |
|------|------|------|
| 添加 JGit 依赖 | ✅ | org.eclipse.jgit 7.1.0 |
| 新增 `GitDiffTool` | ✅ | 灵活的 Git 差异分析工具 |

### 4.2 差异分析（灵活设计）

| 任务 | 状态 | 说明 |
|------|------|------|
| 未提交变更检测 | ✅ | 默认模式：工作区 + 暂存区相对于 HEAD |
| 暂存区分析 | ✅ | STAGED_ONLY 模式 |
| 任意 Ref 比较 | ✅ | COMPARE_REFS 模式，不硬编码分支名 |
| 分支列表工具 | ✅ | 帮助用户发现可用分支 |
| 文件 Diff 详情 | ✅ | 获取具体文件的变更内容 |

### 4.3 增量生成工作流

| 任务 | 状态 | 说明 |
|------|------|------|
| IncrementalAnalyzer | ✅ | 整合 Git 差异与测试任务生成 |
| AppConfig 增量配置 | ✅ | 支持 mode/baseRef/targetRef 配置 |
| CLI 增加 --incremental 参数 | ⏳ | 后续集成到主流程 |
| 变更影响范围分析 | ⏳ | 识别依赖此类的其他测试 |

---

## Phase 5: 测试质量评估与反馈循环 (Quality & Feedback)

**目标**: 从"能跑"进化为"高质量"。

### 5.1 变异测试集成

| 任务 | 状态 | 说明 |
|------|------|------|
| PITest 插件集成 | ⏳ | 检测测试有效性 |
| 变异分数报告 | ⏳ | 评估测试质量 |

### 5.2 边界值覆盖分析

| 任务 | 状态 | 说明 |
|------|------|------|
| AST 条件分支分析 | ⏳ | 识别 if/switch 边界 |
| 边界值测试建议 | ⏳ | null, empty, max/min |

### 5.3 覆盖率反馈环

| 任务 | 状态 | 说明 |
|------|------|------|
| 智能决策修改/新增测试 | ⏳ | 根据未覆盖方法特征判断 |
| 多轮覆盖率提升 | ⏳ | 直到达标或无法继续 |

---

## 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-12 | 0.2.0 | 创建开发路线图 |
| 2026-01-12 | 0.2.1 | 完成 Phase 1.1 核心工具单元测试 (FileSystemTool, DirectoryTool, CodeAnalyzerTool, CoverageTool) |
| 2026-01-12 | 0.2.2 | 完成 Phase 1.2 统一异常类 AgentToolException |
| 2026-01-12 | 0.2.3 | 完成 Phase 1.3 ConfigValidator 配置校验与默认值 |
| 2026-01-12 | 0.3.0 | 完成 Phase 2: StyleAnalyzerTool, KnowledgeBaseTool 增强, DynamicPromptBuilder |
| 2026-01-12 | 0.4.0 | 完成 Phase 3: TestReportTool, RepairTracker 自动修复增强 |
| 2026-01-12 | 0.5.0 | 完成 Phase 4: GitDiffTool, IncrementalAnalyzer 增量检测（灵活 ref 比较） |