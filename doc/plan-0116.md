# Plan 0116: 工程优化迭代计划

**日期**: 2026-01-16  
**版本**: 1.0.0  
**状态**: 进行中

---

## 1. 背景

经过对设计文档（spec.md, design-custom-agent-framework.md, plan.md）与当前实现的对比检查，发现以下待优化项：

### 1.1 当前实现完成度

| 模块 | 完成度 | 说明 |
|------|--------|------|
| 核心规范 (spec.md) | 100% | 所有功能已实现 |
| 自研框架 (design-custom-agent-framework.md) | 95% | 框架完整，验收标准需验证 |
| 开发路线图 Phase 1-5 | 95% | 主功能完成，部分待办遗留 |
| 动态工具选择 (plan-0114.md) | 100% | Skills 机制已完成 |
| 逐函数单测生成 (plan-0115.md) | 100% | MethodIteratorTool 已实现 |

### 1.2 遗留问题

1. **知识库索引持久化** - 每次启动都要重建向量索引，大项目耗时
2. **变更影响范围分析** - 增量模式缺少依赖关系追踪
3. **核心组件单元测试不足** - framework/ 目录下测试覆盖率待提升
4. **迭代模式智能停止** - 可优化停滞检测逻辑

---

## 2. 优化任务

### Phase 1: 单元测试补充 (优先级: P0)

**目标**: 为 framework/ 核心组件补充单元测试，确保框架稳定性

| 任务 | 状态 | 说明 |
|------|------|------|
| ContextManager 单元测试 | ⏳ | 测试消息管理、裁剪、清除 |
| ToolRegistry 单元测试 | ⏳ | 测试工具注册、Schema 生成、调用 |
| AgentExecutor 单元测试 | ⏳ | 测试 ReAct 循环、超时、重试 |
| JsonUtil 单元测试 | ⏳ | 测试 JSON 解析、序列化 |

**验收标准**:
- [ ] framework/ 核心组件测试覆盖率 > 60%
- [ ] 所有测试通过

### Phase 2: 知识库索引持久化 (优先级: P1) ✅ 已完成

**目标**: 避免每次启动重建向量索引，提升大项目启动速度

| 任务 | 状态 | 说明 |
|------|------|------|
| 设计缓存目录结构 | ✅ | `.utagent/kb-cache.json` |
| 实现索引序列化/反序列化 | ✅ | Jackson 保存/加载文档数据 |
| 添加缓存有效性检查 | ✅ | 文件修改时间比对 + MD5 哈希 |
| 新增缓存管理方法 | ✅ | `clearCache()`, `rebuild()`, `rebuildKnowledgeBase()` |

**验收标准**:
- [x] 二次启动不重建索引 (从缓存加载)
- [x] 文件变更后自动检测并重建

### Phase 3: 变更影响范围分析 (优先级: P2) ✅ 已完成

**目标**: 增量模式下识别变更代码影响的测试

| 任务 | 状态 | 说明 |
|------|------|------|
| 实现类依赖图构建 | ✅ | 扫描 import 和对象创建表达式 |
| 新增 `analyzeImpactScope` 方法 | ✅ | IncrementalAnalyzer 扩展 |
| 新增 `DependencyGraph` 类 | ✅ | 支持正向/反向依赖查询 |
| 新增 `ImpactAnalysisResult` 类 | ✅ | 包含变更类、受影响类、测试列表 |

**验收标准**:
- [x] 能识别出依赖变更类的其他类
- [x] 输出可能需要更新的测试文件列表

### Phase 4: 迭代模式智能停止优化 (优先级: P2) ✅ 已完成

**目标**: 优化 CoverageFeedbackEngine 的停滞检测逻辑

| 任务 | 状态 | 说明 |
|------|------|------|
| 增强停滞检测算法 | ✅ | 多种停止条件检测 |
| 添加配置项 | ✅ | `max-stale-iterations`, `min-coverage-gain` |
| 新增 `StopReason` 枚举 | ✅ | 5 种停止原因 |
| 新增 `ContinuationResult` 类 | ✅ | 包含详细决策信息和建议 |
| 优化反馈报告 | ✅ | 显示停止原因和改进建议 |

**验收标准**:
- [x] 无效迭代能被及时检测并停止
- [x] 配置灵活可调 (agent.yml)

---

## 3. 实施计划

### 3.1 时间安排

| 阶段 | 任务 | 预估时间 | 开始日期 |
|------|------|----------|----------|
| Phase 1 | 单元测试补充 | 1-2 天 | 2026-01-16 |
| Phase 2 | 知识库索引持久化 | 1 天 | Phase 1 完成后 |
| Phase 3 | 变更影响范围分析 | 2 天 | Phase 2 完成后 |
| Phase 4 | 迭代模式智能停止 | 0.5 天 | Phase 3 完成后 |

### 3.2 执行顺序

```
Phase 1: 单元测试补充
    └── ContextManagerTest
    └── ToolRegistryTest
    └── AgentExecutorTest
    └── JsonUtilTest
    
Phase 2: 知识库索引持久化
    └── KnowledgeBaseTool 扩展
    
Phase 3: 变更影响范围分析
    └── IncrementalAnalyzer 扩展
    
Phase 4: 迭代模式智能停止
    └── CoverageFeedbackEngine 优化
```

---

---

## 5. 已取消的特性

以下特性经评估后决定**不再实现**，原因如下：

| 特性 | 状态 | 取消原因 |
|------|------|----------|
| 验证JAR体积 | ❌ 取消 | 当前 JAR 体积已可接受，优化投入产出比低 |
| GraalVM Native Image | ❌ 取消 | 反射和动态类加载兼容性问题多，维护成本高 |
| IDE插件 | ❌ 取消 | 当前 CLI 模式已满足需求，插件开发周期长 |
| 智谱AI独立适配器 | ❌ 取消 | 已通过 openai-zhipu 协议兼容，无需独立适配器 |

---

## 6. 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-16 | 1.0.0 | 初始计划创建 |
| 2026-01-16 | 1.1.0 | Phase 1 完成：ContextManager/ToolRegistry/JsonUtil 单元测试 |
| 2026-01-16 | 1.2.0 | Phase 2 完成：KnowledgeBaseTool 索引持久化 |
| 2026-01-16 | 1.3.0 | Phase 3 完成：IncrementalAnalyzer 变更影响范围分析 |
| 2026-01-16 | 1.4.0 | Phase 4 完成：CoverageFeedbackEngine 智能停止优化 |
