# Plan 0114: 动态工具传递机制 (Dynamic Tool Selection)

**日期**: 2026-01-14  
**优先级**: 中高  
**状态**: 进行中

---

## 1. 背景与动机

当前实现中，所有工具在启动时一次性加载并全量传递给 LLM。这导致：
- **Token 浪费**: 每次 LLM 调用都携带 ~15 个工具的完整定义（约 2000-3000 tokens）
- **上下文污染**: 某些阶段不需要的工具定义占用宝贵的上下文窗口
- **灵活性差**: 无法根据任务类型定制可用工具集

## 2. 目标

实现基于 **Skill（技能）** 的动态工具传递机制：
- 根据任务阶段/类型，按需传递工具子集
- 减少 **60-70%** 的工具定义 token 消耗
- 保持向后兼容（不定义 skill 时使用全量工具）

## 3. 设计方案

### 3.1 配置扩展 (`agent.yml`)

```yaml
skills:
  - name: "analysis"
    description: "代码分析阶段 - 读取和理解源代码"
    tools:
      - CodeAnalyzerTool
      - FileSystemTool
      - BoundaryAnalyzerTool
      - StyleAnalyzerTool
      
  - name: "generation"
    description: "测试生成阶段 - 生成并写入测试代码"
    tools:
      - FileSystemTool
      - DirectoryTool
      - KnowledgeBaseTool
      - SyntaxCheckerTool
      
  - name: "verification"
    description: "测试验证阶段 - 执行测试并验证覆盖率"
    tools:
      - MavenExecutorTool
      - TestReportTool
      - CoverageTool
      - FileSystemTool
      
  - name: "repair"
    description: "修复阶段 - 根据错误修复测试"
    tools:
      - FileSystemTool
      - TestReportTool
      - CodeAnalyzerTool
      - SyntaxCheckerTool

  - name: "full"
    description: "完整工具集（默认）"
    tools: []  # 空数组表示使用全部工具
```

### 3.2 代码改动

#### 3.2.1 `AppConfig.SkillConfig` 扩展

```java
@Data
public static class SkillConfig {
    private String name;
    private String description;
    private String type;
    private Map<String, Object> params;
    private List<String> tools;  // 新增：工具类名列表
}
```

#### 3.2.2 `ToolFactory` 改造

新增方法：
- `loadToolsForSkill(AppConfig config, String skillName, String knowledgeBasePath)` - 按 skill 加载工具
- `filterToolsByNames(List<Object> allTools, List<String> toolNames)` - 按名称过滤工具

#### 3.2.3 `AgentOrchestrator` 改造

- 支持在 `createAssistant()` 时指定 skill
- 新增 `setCurrentSkill(String skillName)` 方法动态切换工具集
- 默认使用 "full" skill（向后兼容）

### 3.3 使用方式

**方式一：配置文件指定默认 skill**
```yaml
workflow:
  defaultSkill: "full"
```

**方式二：CLI 参数**
```bash
java -jar utagent.jar --target Foo.java --skill analysis
```

**方式三：多阶段执行（未来扩展）**
Agent 自动根据工作流阶段切换 skill。

## 4. 实现步骤

| 步骤 | 任务 | 文件 | 状态 |
|------|------|------|------|
| 1 | 扩展 SkillConfig 添加 tools 字段 | AppConfig.java | ✅ 已完成 |
| 2 | 修改 ToolFactory 支持按 skill 过滤 | ToolFactory.java | ✅ 已完成 |
| 3 | 修改 AgentOrchestrator 支持动态工具集 | AgentOrchestrator.java | ✅ 已完成 |
| 4 | 更新 agent.yml 添加默认 skill 定义 | agent.yml | ✅ 已完成 |
| 5 | 更新文档 | CLAUDE.md | ✅ 已完成 |
| 6 | 添加 CLI --skill 参数 | App.java | ✅ 已完成 |

## 5. Token 节省估算

| 场景 | 工具数量 | 估算 Token | 节省 |
|------|----------|------------|------|
| 全量工具 | ~15 | ~2500 | 基准 |
| analysis skill | 4 | ~700 | 72% |
| generation skill | 4 | ~700 | 72% |
| verification skill | 4 | ~700 | 72% |
| repair skill | 4 | ~700 | 72% |

## 6. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Skill 定义缺少必要工具 | 任务失败 | 提供 "full" 兜底 skill |
| 配置复杂度增加 | 用户困惑 | 提供合理默认值，无需配置即可使用 |
| 运行时切换 skill | 状态管理复杂 | 初期仅支持启动时指定，后续迭代 |

## 7. 验收标准

- [x] 计划文档完成
- [x] 不配置 skills 时，行为与原有一致（全量工具）
- [x] 配置 skills 后，仅传递指定工具
- [x] 单元测试通过
- [ ] 集成测试验证 token 减少（待手动验证）

---

## 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-14 | v0.1 | 初始计划创建 |
| 2026-01-14 | v1.0 | 功能实现完成 |

## 8. 实现摘要

### 修改的文件

1. **AppConfig.java**
   - `SkillConfig` 添加 `tools` 字段
   - `WorkflowConfig` 添加 `defaultSkill` 字段

2. **ToolFactory.java**
   - 新增 `loadAndWrapTools(config, path, skillName)` 重载方法
   - 新增 `filterToolsBySkill()` 按 skill 过滤工具
   - 新增 `filterToolsByNames()` 按名称列表过滤工具
   - 新增 `getAvailableSkillNames()` 获取可用 skills

3. **AgentOrchestrator.java**
   - `tools` 重命名为 `allTools`
   - 新增 `activeTools` 当前激活的工具子集
   - 新增 `currentSkill` 当前 skill 名称
   - 新增 `setSkill()` 动态切换工具集
   - 新增 `getCurrentSkill()` / `getActiveToolCount()`

4. **App.java**
   - 新增 `--skill` CLI 参数
   - 工具加载时考虑 skill 配置

5. **agent.yml**
   - 添加 5 个内置 skill 定义
   - 添加 `workflow.default-skill` 配置项

6. **CLAUDE.md**
   - 添加动态工具选择文档
   - 更新 CLI 参数表格
